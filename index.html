<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è®¡ç½‘åˆ·é¢˜ä¸“ä¸šç‰ˆ</title>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --bg: #f0f2f5; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #eef7ff; padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 13px; }
        .q-text { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; min-height: 60px; }
        .option { display: block; width: 100%; padding: 15px; margin: 12px 0; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: 0.2s; font-size: 16px; text-align: left; background: white; }
        .correct { background: #d4edda !important; border-color: var(--success) !important; color: #155724; font-weight: bold; }
        .wrong { background: #f8d7da !important; border-color: var(--danger) !important; color: #721c24; }
        .analysis { margin-top: 20px; padding: 15px; background: #fff9db; border-radius: 10px; border-left: 5px solid #f1c40f; display: none; font-size: 14px; line-height: 1.6; }
        .nav-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 15px; text-align: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-wrong-set { background: #f39c12; color: white; }
        .btn-list { background: #673ab7; color: white; grid-column: span 2; }
        .btn-reset { background: #95a5a6; color: white; padding: 5px 10px; font-size: 12px; }
        
        /* é¢˜ç›®åˆ—è¡¨æ ·å¼ */
        #question-list { 
            display: none; 
            max-height: 300px; 
            overflow-y: auto; 
            background: #f9f9f9; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            margin-top: 15px; 
            padding: 10px; 
        }
        .list-item { 
            padding: 10px; 
            border-bottom: 1px solid #eee; 
            cursor: pointer; 
            font-size: 14px; 
            color: #666;
        }
        .list-item:hover { background: #eef7ff; }
        .list-item.active { color: var(--primary); font-weight: bold; background: #eef7ff; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h3 id="mode-title" style="margin:0">å…¨é¢˜åº“æ¨¡å¼</h3>
        <button class="btn btn-reset" onclick="clearProgress()">é‡ç½®è¿›åº¦</button>
    </div>
    <div class="stats">
        <div>è¿›åº¦: <span id="progress">0/0</span></div>
        <div>é”™é¢˜æœ¬: <span id="wrong-count">0</span></div>
        <div>æ­£ç¡®ç‡: <span id="accuracy">0%</span></div>
        <div>å¾—åˆ†: <span id="score">0</span></div>
    </div>

    <div id="quiz-area">
        <div id="question" class="q-text">æ­£åœ¨åŠ è½½é¢˜ç›®...</div>
        <div id="options"></div>
        <div id="explanation" class="analysis"></div>
    </div>

    <div class="nav-btns">
        <button class="btn btn-list" onclick="toggleList()">æŸ¥çœ‹é¢˜ç›®åˆ—è¡¨ / è·³è½¬</button>
        <button id="wrong-btn" class="btn btn-wrong-set" onclick="toggleMode()">è¿›å…¥é”™é¢˜é›†</button>
        <button id="next-btn" class="btn btn-primary" onclick="nextQ()" disabled>ä¸‹ä¸€é¢˜</button>
    </div>

    <div id="question-list"></div>
</div>

<script src="questions.js"></script>

<script>
    let currentPool = [];
    let currentIndex = 0;
    let score = 0;
    let totalAttempted = 0; // æ–°å¢ï¼šç”¨äºè®°å½•æ€»ç­”é¢˜æ•°ï¼Œæ–¹ä¾¿è·¨è·³è½¬è®¡ç®—æ­£ç¡®ç‡
    let wrongSet = JSON.parse(localStorage.getItem('wrong_set')) || [];
    let isWrongMode = false;

    function init() {
        if (typeof allQuestions === 'undefined' || allQuestions.length === 0) {
            document.getElementById('question').innerText = "æ‰¾ä¸åˆ°é¢˜åº“æ–‡ä»¶æˆ–æ•°æ®ä¸ºç©ºï¼è¯·æ£€æŸ¥ questions.js æ–‡ä»¶ã€‚";
            return;
        }
        currentPool = [...allQuestions];
        updateStats();
        showQuestion();
    }

    function showQuestion() {
        const q = currentPool[currentIndex];
        document.getElementById('question').innerText = `${currentIndex + 1}. ${q.q}`;
        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = '';
        document.getElementById('explanation').style.display = 'none';
        document.getElementById('next-btn').disabled = true;

        q.a.forEach((txt, i) => {
            const btn = document.createElement('button');
            btn.className = 'option';
            btn.innerText = txt;
            btn.onclick = () => check(i, q.ok, btn);
            optionsDiv.appendChild(btn);
        });
        
        // æ¯æ¬¡æ˜¾ç¤ºé¢˜ç›®æ—¶ï¼Œå¦‚æœåˆ—è¡¨æ˜¯æ‰“å¼€çš„ï¼ŒåŒæ­¥é«˜äº®
        if (document.getElementById('question-list').style.display === 'block') {
            renderList();
        }
    }

    function check(selected, correct, el) {
        if (!document.getElementById('next-btn').disabled) return;
        const opts = document.getElementsByClassName('option');
        totalAttempted++;
        
        if (selected === correct) {
            el.classList.add('correct');
            score++;
        } else {
            el.classList.add('wrong');
            opts[correct].classList.add('correct');
            // å­˜å…¥é”™é¢˜æœ¬
            if (!wrongSet.find(x => x.q === currentPool[currentIndex].q)) {
                wrongSet.push(currentPool[currentIndex]);
                localStorage.setItem('wrong_set', JSON.stringify(wrongSet));
            }
        }
        const expBox = document.getElementById('explanation');
        expBox.style.display = 'block';
        expBox.innerHTML = `<strong>ã€æ­£ç¡®ç­”æ¡ˆã€‘</strong> ${currentPool[currentIndex].a[correct]}<br><strong>ã€è§£æã€‘</strong> ${currentPool[currentIndex].exp}`;
        document.getElementById('next-btn').disabled = false;
        updateStats();
    }

    function nextQ() {
        currentIndex++;
        if (currentIndex < currentPool.length) {
            showQuestion();
        } else {
            alert(isWrongMode ? "å¤ä¹ å®Œæˆï¼" : "å…¨é¢˜åº“ç»ƒä¹ å®Œæˆï¼");
            currentIndex = 0; 
            if(isWrongMode) toggleMode();
            else { score = 0; totalAttempted = 0; showQuestion(); }
        }
        updateStats();
    }

    // --- æ–°å¢ï¼šé¢˜ç›®åˆ—è¡¨åŠŸèƒ½ ---
    function toggleList() {
        const listDiv = document.getElementById('question-list');
        if (listDiv.style.display === 'block') {
            listDiv.style.display = 'none';
        } else {
            listDiv.style.display = 'block';
            renderList();
        }
    }

    function renderList() {
        const listDiv = document.getElementById('question-list');
        listDiv.innerHTML = '<h4 style="margin:0 0 10px 0; color:#333;">é¢˜ç›®å¿«æ·è·³è½¬</h4>';
        
        currentPool.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = `list-item ${index === currentIndex ? 'active' : ''}`;
            
            // æˆªå–é¢˜ç›®é¢„è§ˆ
            const preview = item.q.length > 25 ? item.q.substring(0, 25) + '...' : item.q;
            div.innerHTML = `<span>${index + 1}. ${preview}</span>`;
            
            div.onclick = () => {
                currentIndex = index;
                showQuestion();
                updateStats();
                // å¯é€‰ï¼šç‚¹å‡»åè‡ªåŠ¨å…³é—­åˆ—è¡¨
                // listDiv.style.display = 'none';
            };
            listDiv.appendChild(div);
        });
    }

    function toggleMode() {
        isWrongMode = !isWrongMode;
        if (isWrongMode) {
            if (wrongSet.length === 0) { 
                alert("æš‚æ— é”™é¢˜è®°å½•ï¼"); 
                isWrongMode = false; 
                return; 
            }
            currentPool = [...wrongSet];
            document.getElementById('mode-title').innerText = "ğŸ”´ é”™é¢˜å¤ä¹ ";
            document.getElementById('wrong-btn').innerText = "è¿”å›å…¨é¢˜åº“";
        } else {
            currentPool = [...allQuestions];
            document.getElementById('mode-title').innerText = "å…¨é¢˜åº“æ¨¡å¼";
            document.getElementById('wrong-btn').innerText = "è¿›å…¥é”™é¢˜é›†";
        }
        currentIndex = 0; 
        score = 0; 
        totalAttempted = 0;
        showQuestion(); 
        updateStats();
    }

    function updateStats() {
        document.getElementById('progress').innerText = `${currentIndex + 1}/${currentPool.length}`;
        document.getElementById('wrong-count').innerText = wrongSet.length;
        document.getElementById('score').innerText = score;
        
        const acc = totalAttempted === 0 ? 0 : Math.round(score / totalAttempted * 100);
        document.getElementById('accuracy').innerText = acc + '%';
    }

    function clearProgress() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å¹¶é‡ç½®å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onload = init;
</script>
</body>
</html>